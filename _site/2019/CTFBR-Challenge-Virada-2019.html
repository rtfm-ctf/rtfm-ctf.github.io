<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" class="no-js">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta charset="UTF-8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  
  

  <title>
      CTF-BR Challenge da Virada 2018-2019 (hall-of-fame) · RTFM
  </title>

  
  

  

  <meta name="description" content="
      Challenge da Virada 2018-2019 CTF-BR para Hall of Fame
  "/>
  <meta name="keywords" content="ctf-br, hall-of-fame, forensics">
  <meta name="author" content="Red Team Freakin' Maniacs">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">

  
  
  

  <!-- Social: Facebook / Open Graph -->
  
  <meta property="og:type" content="article">
  <meta property="article:author" content="Red Team Freakin' Maniacs">
  <meta property="article:section" content="">
  <meta property="article:tag" content="ctf-br, hall-of-fame, forensics">
  <meta property="article:published_time" content="2019-01-03 00:00:00 -0200">
  
  <meta property="og:url" content="http://localhost:4000/2019/CTFBR-Challenge-Virada-2019">
  <meta property="og:title" content="
      CTF-BR Challenge da Virada 2018-2019 (hall-of-fame) · RTFM
  ">
  <meta property="og:image" content="http://localhost:4000">
  <meta property="og:description" content="
      Challenge da Virada 2018-2019 CTF-BR para Hall of Fame
  ">
  <meta property="og:site_name" content="Red Team Freakin' Maniacs">
  <meta property="og:locale" content="en_US">

  <!-- Social: Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@rtfmctf">
  <meta name="twitter:title" content="
      CTF-BR Challenge da Virada 2018-2019 (hall-of-fame) · RTFM
  ">
  <meta name="twitter:description" content="
      Challenge da Virada 2018-2019 CTF-BR para Hall of Fame
  ">
  <meta name="twitter:image:src" content="http://localhost:4000">

  <!-- Social: Google+ / Schema.org  -->
  <meta itemprop="name" content="
      CTF-BR Challenge da Virada 2018-2019 (hall-of-fame) · RTFM
  ">
  <meta itemprop="description" content="
      Challenge da Virada 2018-2019 CTF-BR para Hall of Fame
  ">
  <meta itemprop="image" content="http://localhost:4000">

  <meta name="msapplication-TileColor" content="#f3f3f3">
  <meta name="theme-color" content="#ffffff">

  <meta name="google-site-verification" content="aSavCGGU0uSN5HEHnI7ZiMqVKxn7mfUPCGMVJvmDQ1w" />
  <meta name="wot-verification" content="6da2597a332a1fadad8f"/>

  <!-- Canonical link tag -->
  <link rel="canonical" href="http://localhost:4000/2019/CTFBR-Challenge-Virada-2019">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://localhost:4000/feed.xml">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/font-awesome.min.css">

  <script src="/assets/js/modernizr.custom.js"></script>

  <!--[if lt IE 9]>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.1.0/respond.min.js"></script>
    <script src="/assets/js/rem.min.js"></script>
  <![endif]-->
</head>

  <body>

    <div class="wrap">
      <div class="master-nav">
        <div class="nav">
            <ul class="top-menu">
              <li><a href="/"><i class="fa fa-home"></i> Home</a></li>
              <li><a href="/about.html"><i class="fa fa-user"></i> About</a></li>
              <li><a href="/writeups.html"><i class="fa fa-file-text"></i> Writeups</a></li>
              <li><a href="/events.html"><i class="fa fa-trophy"></i> Events</a></li>
            </ul>
        </div>
      </div>

      <div class="masthead">
        <div class="container">
          <h2 class="masthead-title">
            <p align="center"><img src='/assets/logo.png' width="130px" height="130px" /></p>
            <a href="/" title="Home">Red Team Freakin' Maniacs</a>
            <small></small>
          </h2>

          <div class="footer-social-links">
  <a href="https://www.facebook.com/RedTeamFreakinManiacs" title="Facebook" target="_blank"><i class="fa fa-facebook"></i></a>
  <a href="https://twitter.com/rtfmctf" title="Twitter" target="_blank"><i class="fa fa-twitter"></i></a>
  <a href="https://github.com/rtfm-ctf" title="GitHub" target="_blank"><i class="fa fa-github-alt"></i></a>
  <a href="https://ctftime.org/team/16856" title="CTFTime"><i class="fa fa-terminal"></i></a>
  <a href="mailto:contato@rtfm-ctf.org" title="Contact"><i class="fa fa-comment-o"></i></a>
</div>


        </div>
      </div>

      <div class="container content">
        <div class="post">
  <div class="post-top-meta">
    <div class="post-date">January 03, 2019 &middot; <span class="reading-time" title="Estimated Reading Time">
  
  
    6 minutes read
  
</span>
</div>
    <h1 class="post-title">CTF-BR Challenge da Virada 2018-2019 (hall-of-fame)</h1>
  </div>

  <ul>
  <li><strong>CTF:</strong> CTF-BR Hall Of Fame</li>
  <li><strong>Challenge:</strong> Challenge da Virada 2018-2019</li>
  <li><strong>Category:</strong> Forensics, Rev</li>
  <li><strong>Solved by:</strong> RTFM[ChOkO]</li>
</ul>

<h1 id="challenge-da-virada-2018---2019">CHALLENGE DA VIRADA (2018 -&gt; 2019)</h1>

<blockquote>
  <p>Challenge da virada (2018 -&gt; 2019)</p>

  <p>Resolvido por: aguardando</p>

  <p>Nome: Rootkit</p>

  <p>Descrição: Suspeitamos que um de nossos servidores foi ownado pela Inteligência da Bloodsuckers. Tudo indica para o fato de terem instalado um binary rootkit em nosso sistema, visando conseguir nossas credenciais para tentarem usar em outros servidores. Faça uma análise forense no dump do sistema, e ao identificar o comprometimento, faça um reversing para identificar a senha que dá acesso ao dump (sniffer) das senhas. Após isso, entendendo o funcionamento do rk, obtenha a última senha legítima utilizada pelo root na máquina, pois achamos que ela foi mudada pelo pessoal da Inteligência por uma default deles, e também pode nos ser útil em outros dos seus sistemas, como a de dump! (o feitiço virou contra o feiticeiro!). Submeta no formato CTF-BR{SenhaUsadaParaDump,UltimaSenhaRootLegitima}. Não temos as credenciais, isso faz parte do desafio.</p>

  <p>Categoria: Forensics</p>

  <p>Link do arquivo: <a href="https://static.pwn2win.party/2017/rootkit_3e4df5d6a3926cbc81ebf014a82098ad0964653aaedf581cd1bbc06eb3756642.tar.gz">aqui</a></p>

  <p>Write-up do vencedor: aguardando</p>

  <p>Lançamento: 31 de dezembro de 2018</p>

  <p>Resolução: aguardando</p>
</blockquote>

<p><strong>WRITE-UP</strong></p>

<p>Este ano o desafio do CTF-BR para o <a href="https://ctf-br.org/hall-of-fame/">Hall of Fame</a> trouxe um desafio de forense bem interessante. Aparentemente um de nossos servidores foi ownado e pra melhorar instalaram um rootkit…!</p>

<p>![¬<strong>_¬’](https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRlZRFJevs0yhUbh1NBE7QsxQ9VohUZ86ErbhudcxmxHi_15W7l “Malditos Hackers ¬</strong>¬’”)</p>

<p>O desafio nos pede para analisar o dump do sistema e determinar duas coisas:</p>
<ol>
  <li>senha utilizada para dump, e;</li>
  <li>última senha root legítima.</li>
</ol>

<p>Após o download primeiro verifiquei qual o tipo de arquivo:
<img src="https://i.imgur.com/ffFO7Wi.png" alt="File type" /></p>

<p>Fazendo jus à minha fama de desconfiado, também confiro o hash do arquivo:</p>

<p><img src="https://i.imgur.com/FCx4Sip.png" alt="epa, hashes diferentes? Õ_õ...esse gnx eh f0dz " /></p>

<p>Como o challenge não informou as credenciais desta máquina, resolvi seguir duas abordagens:</p>
<ol>
  <li>recuperar os arquivos da imagem dada utilizando o <a href="https://www.cgsecurity.org/wiki/PhotoRec">photorec</a>, e;</li>
  <li>alterar a senha do root para facilitar a análise <em>ao vivo</em> da máquina.</li>
</ol>

<h2 id="recuperando-arquivos-com-o-photorec">Recuperando arquivos com o photorec</h2>

<p>O photorec é excelente para recuperação de arquivos. Basta criar um diretório de saída para os arquivos recuperados e executa-lo passando o arquivo da imagem como parâmetro:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>photo
photorec ub1404lts-disk1.vmdk
</code></pre></div></div>

<p><img src="https://i.imgur.com/g5N10lA.png" alt="photorec" /></p>

<p>Feito isso, o programa recuperou diversos arquivos e os dividiu em 29 diretórios (recup_dir.xx). A idéia era procurar por algum indicativo deste malware na imagem. Como não sabia o que procurar tentei a string ‘rootkit’ \o/!</p>

<p><img src="https://i.imgur.com/ONzfU6R.png" alt="grep -ri rootkit" /></p>

<p>Analisando o script observamos que a senha utilizada para <em>dump</em> é definida como MAGIC_VERSION no arquivo bonny.h, conforme destaque a seguir:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">_BONNY_</span><span class="sh"> &gt; version.h
#define SSH_VERSION     "</span><span class="nv">$FAKEV</span><span class="sh">"
#define SSH_PORTABLE    "</span><span class="nv">$FAKEP</span><span class="sh">"
#define SSH_RELEASE     SSH_VERSION SSH_PORTABLE
</span><span class="no">_BONNY_

</span>: <span class="k">${</span><span class="nv">CBDPASS</span>:<span class="p">=</span><span class="sb">`</span>./mkpasswd <span class="nt">-p</span> <span class="nv">$UBDPASS</span><span class="sb">`</span><span class="k">}</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">_BONNY_</span><span class="sh"> &gt; bonny.h
#define BD_PASS			"</span><span class="nv">$CBDPASS</span><span class="sh">"
#define MAGIC_VERSION	"</span><span class="nv">$UDPPASS</span><span class="sh">"
#define SKYCOMMAND      "</span><span class="nv">$USPPASS</span><span class="sh">"
</span><span class="no">_BONNY_
</span></code></pre></div></div>

<p>Ok, estamos um passo mais próximos de obter a nossa primeira flag (senha utilizada para o dump). Buscando por bonny.h encontramos outro fonte. O arquivo recuperado veio pela metade, mas ajudou a ter uma idéia melhor sobre o que procurar.</p>

<p><img src="https://i.imgur.com/DeiARfW.png" alt="trecho do rootkit" /></p>

<p>Passando rapidamente pelo código, este rootkit substitui os binários do ssh e sshd por sua versão infectada (mas como o autor é bonzinho ele faz o backup dos arquivos para você antes de te infectar :)…</p>

<pre><code class="language-script">mv /usr/bin/ssh ssh.old &amp;&amp; cp ssh /usr/bin/ssh &amp;&amp; mv /usr/sbin/sshd sshd.old &amp;&amp; cp sshd /usr/sbin/sshd
</code></pre>

<p>Neste momento comecei a pesquisar por rootkits com estes nomes: skynet, skylnx e bonny, dentre outras strings que aparecem no fonte. Viajei por algum um tempo e lembrei que ainda não havia investigado a máquina. Com as informações que consegui até então ficou mais fácil procurar o que eu queria no sistema. <em>OBs: cabe ressaltar que a este ponto após analisar alguns arquivos que foram recuperados, encontrei um .tar.gz que possuía o fonte do rootkit skylnx.</em></p>

<h2 id="análise-da-máquina-viva">Análise da máquina ‘viva’</h2>

<p>Nesta análise utilizei uma máquina virtual Ubuntu que tinha pego da <a href="https://www.osboxes.org/">OSBoxes</a> e apenas substitui seu disco pela imagem do desafio. As credenciais não foram informadas, então substituí a senha do <a href="https://unix.stackexchange.com/questions/76313/change-password-of-a-user-in-etc-shadow">root</a> por <em>password</em> alterando o <a href="https://askubuntu.com/questions/24006/how-do-i-reset-a-lost-administrative-password">menu do grub</a>.</p>

<p><img src="https://i.imgur.com/dkHZsez.png" alt="resetando senha do user" /></p>

<p>Agora com acesso comecei a investigar melhor o servidor SSH (/usr/sbin/sshd). Pude identificar que a versão do SSHD realmente havia sido modificada pelo rootkit:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@rf-server4:/# <span class="nb">grep </span>skylnx /usr/sbin/sshd       
Binary file /usr/sbin/sshd matches
</code></pre></div></div>

<p>Reparei que não havia encontrado o arquivo bonny.h (que possui as senhas para operação do rootkit) nos arquivos recuperados pelo photorec. Então fiz uma pesquisa nos ELF (mais uma vez, salvo pelo SANTO STRINGS) e encontrei lá (no que deve ser o binário do SSHD) as senhas.</p>

<p><img src="https://i.imgur.com/uwcUqFl.png" alt="rootkit strings" /></p>

<p>Após mais algum tempo no código-fonte resolvi que daria muito trabalho criar o meu próprio cliente SSH para enviar as strings de versão que o rootkit estava esperando (mas pode ser um bom exercício se você está aprendendo programação). Como eu não confio no gnx (e você também não deveria) resolvi baixar o código do rootkit para a máquina ownada e comecei a brincar a partir dela.</p>

<p><img src="https://i.imgur.com/MlXoRxH.png" alt="rodando o rootkit" /></p>

<p>Depois de algum tempo entendi o funcionamento do <em>skycommand.c</em> e compilei o meu <em>skycmd</em> para conseguir realizar o dump que o desafio pede:</p>
<pre><code class="language-script">root@rf-server4:/tmp/tmp.sQwn28gO1I/skylnx2# ./skycmd 127.0.0.1 22 wl4SUuXeSU
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
SSH-2.0-OpenSSH_6.6.1
pass_from: ::1 	user: root 	pass: ohcohYie9E
pass_from: 192.168.0.177 	user: root 	pass: ohcohYie9E
pass_from: 192.168.0.177 	user: root 	pass: AhooCo7wei
pass_from: 192.168.0.177 	user: root 	pass: OhCeW4ahsh             
pass_from: 192.168.0.177 	user: root 	pass: Woemash9ie4chee7Oe4p   # última senha válida do root :)
pass_from: 192.168.250.1 	user: user 	pass: password               # senha que nós alteramos
</code></pre>

<p>Aprendemos que o código possui três características principais:</p>
<ol>
  <li>permite autenticação como root caso você informe a senha que foi configurada no BD_PASS;</li>
  <li>realiza um dump que revela as credenciais utilizadas nas últimas tentativas válidas de autenticação ao sistema-alvo, quando recebe como informação de versão local do cliente SSH a string configurada em MAGIC_VERSION;</li>
  <li>executa um comando como root se você informar a string configurada em SKYCOMMAND se você executar o binário gerado pelo <em>skycommand.c</em> como a versão local do cliente SSH seguida de um comando.</li>
</ol>

<p><img src="https://i.imgur.com/DEWSlDT.png" alt="client_version_string" />
Gostei do desafio pois fazia uns 3 anos que não mexia com o photorec e nada relacionado a forense e investigação. Também foi muito bom para relembrar conceitos básicos de administração de SO (reset da senha do ubuntu), noções de programação e engenharia reversa.</p>

<h2 id="here-is-a-flag-for-you">Here is a flag for you</h2>
<p><strong>FLAG: CTF-BR{wl4SUuXeSU,Woemash9ie4chee7Oe4p}</strong></p>

<p>\o/ RTFM \o/</p>


</div>
<div class="back"><a href="/"><i class="fa fa-chevron-left"></i> Back to Homepage</a></div>

      </div>
    </div>

    <div class="footer">
	<div class="hrline"></div>
	<div class="copyright"><br>&copy; 2022 Red Team Freakin' Maniacs</div>
</div>

<script>
$(window).load(function() {
	$('.grid').masonry({
		itemSelector: '.grid-item',
		columnWidth: '.grid-sizer',
		gutter: 10
	});
});
</script>


  </body>
</html>
